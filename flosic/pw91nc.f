C UTEP Electronic Structure Lab (2019)
C
C
C ******************************************************************
C
      SUBROUTINE PW91NC(RS,ZET,T,UU,VV,WW,H,DVCUP,DVCDN)
C
C  GGA91 CORRELATION
C  INPUT RS:  SEITZ RADIUS
C  INPUT ZET: RELATIVE SPIN POLARIZATION
C  INPUT T:   ABS(GRAD D)/(D*2*KS*G)
C  INPUT UU:  (GRAD D)*GRAD(ABS(GRAD D))/(D**2 * (2*KS*G)**3)
C  INPUT VV:  (LAPLACIAN D)/(D * (2*KS*G)**2)
C  INPUT WW:  (GRAD D)*(GRAD ZET)/(D * (2*KS*G)**2
C  OUTPUT H:  NONLOCAL PART OF CORRELATION ENERGY PER ELECTRON
C  OUTPUT DVCUP,DVCDN:  NONLOCAL PARTS OF CORRELATION POTENTIALS
C
      IMPLICIT REAL*8 (A-H,O-Z)
      COMMON/PW91GAS/G,EC,ECRS,ECZET
      SAVE
Cdvp  DATA XNU,CC0,CX,ALF/15.75592D0,0.004235D0,-0.001667212D0,0.09D0/
      DATA XNU,CC0,CX/15.75592D0,0.004235D0,-0.001667212D0/
      DATA C1,C2,C3,C4/0.002568D0,0.023266D0,7.389D-6,8.723D0/
      DATA C5,C6,A4/0.472D0,7.389D-2,100.0D0/
      DATA BET,BETR/0.0667263D0,14.98659D0/
      DATA DELT,DELTR/2.697586D0,0.3707018D0/
      DATA RS2R0/0.66343644D0/
      DATA THRD,THRD2/0.3333333333333333D0,0.6666666666666667D0/ 
      DATA SIXTH/0.1666666666666667D0/
      DATA THDSEV/0.4285714285714286D0/
      GR = 1.0D0/G
      G3 = G**3
      G4 = G3*G
      G3R = GR**3
      G4R = G3R*GR
      PON = -DELT*EC*G3R*BETR
      BEX = EXP(PON)-1.0D0
      B = DELT/BEX
      B2 = B*B
      T2 = T*T
      T4 = T2*T2
      T6 = T4*T2
      RS2 = RS*RS
      RS3 = RS2*RS
      Q4 = 1.0D0+B*T2
      Q5 = 1.0D0+B*T2+B2*T4
      Q6 = C1+C2*RS+C3*RS2
      Q7 = 1.0D0+C4*RS+C5*RS2+C6*RS3
      Q7R = 1.0D0/Q7
      CC = -CX + Q6*Q7R
      R0 = RS2R0*RS
      R1 = A4*R0*G4
      COEFF = CC-CC0-THDSEV*CX
      R2 = XNU*COEFF*G3
      R3 = EXP(-R1*T2)
      H0 = G3*BET*DELTR*LOG(1.0D0+DELT*Q4*T2/Q5)
      H1 = R3*R2*T2
      H = H0+H1
C
C  LOCAL CORRELATION OPTION:
C     H = 0.0D0
C
C  ENERGY DONE. NOW THE POTENTIAL:
C
C  ORIGINAL CODE DID NOT WORK FOR ZET = 1 OR ZET = -1
C  BECAUSE IN THIS CASE GZ IS NOT A NUMBER 
C  CRUDE REMEDY: NEXT LINE  
C
      IF ((1.0D0-ABS(ZET)) .LT. 1.0D-10) ZET=(1.0D0-1.0D-10)*ZET
C
      CCRS = (C2+2*C3*RS)*Q7R - Q6*(C4+2*C5*RS
     &        +3*C6*RS2)*Q7R*Q7R
      RSTHRD = RS*THRD
      R4 = RSTHRD*CCRS/COEFF
      GZ = ((1.0D0+ZET)**(-THRD) - (1.0D0-ZET)**(-THRD))*THRD
      FAC = BEX+1.0D0
      BG = -3*B2*EC*FAC*BETR*G4R 
      BEC = B2*FAC*BETR*G3R
      Q8 = Q5*Q5+DELT*Q4*Q5*T2
      Q8R = 1.0D0/Q8
      Q82R = Q8R*Q8R
      Q9 = 1.0D0+2*B*T2
      H0B = -BET*G3*B*T6*(2.0D0+B*T2)*Q8R
      H0RS = -RSTHRD*H0B*BEC*ECRS
      FACT0 = 2*DELT-6*B
      FACT1 = Q5*Q9+Q4*Q9*Q9
      H0BT = 2*BET*G3*T4*(Q4*Q5*FACT0-DELT*FACT1)*Q82R
      H0RST = RSTHRD*T2*H0BT*BEC*ECRS
      H0Z = 3*GZ*H0*GR + H0B*(BG*GZ+BEC*ECZET)
      H0T = 2*BET*G3*Q9*Q8R
      H0ZT = 3*GZ*H0T*GR+H0BT*(BG*GZ+BEC*ECZET)
      FACT2 = Q4*Q5+B*T2*(Q4*Q9+Q5)
      FACT3 = 2*B*Q5*Q9+DELT*FACT2
      H0TT = 4*BET*G3*T*(2*B*Q8R-Q9*FACT3*Q82R)
      H1RS = R3*R2*T2*(-R4+R1*T2*THRD)
      FACT4 = 2.0D0-R1*T2
      H1RST = R3*R2*T2*(2*R4*(1.0D0-R1*T2)-THRD2*R1*T2*FACT4)
      H1Z = GZ*R3*R2*T2*(3.0D0-4*R1*T2)*GR
      H1T = 2*R3*R2*(1.0D0-R1*T2)
      H1ZT = 2*GZ*R3*R2*(3.0D0-11*R1*T2+4*R1*R1*T4)*GR
      H1TT = 4*R3*R2*R1*T*(-2.0D0+R1*T2)
      HRS = H0RS+H1RS
      HRST = H0RST+H1RST
      HT = H0T+H1T
      HTT = H0TT+H1TT
      HZ = H0Z+H1Z
      HZT = H0ZT+H1ZT
      COMM = H+HRS+HRST+T2*HT*SIXTH+7*T2*T*HTT*SIXTH
      PREF = HZ-GZ*T2*HT*GR
      FACT5 = GZ*(2*HT+T*HTT)*GR
      COMM = COMM-PREF*ZET-UU*HTT-VV*HT-WW*(HZT-FACT5)
      DVCUP = COMM + PREF
      DVCDN = COMM - PREF
C
C  LOCAL CORRELATION OPTION:
C
C     DVCUP = 0.0D0
C     DVCDN = 0.0D0
      RETURN
      END
